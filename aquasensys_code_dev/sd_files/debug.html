<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AquaSensys - System Debug</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .debug-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .debug-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .debug-card h3 {
            color: var(--primary);
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .debug-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .debug-label {
            font-weight: 600;
            color: var(--dark);
        }

        .debug-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--secondary);
        }

        .status-ok {
            color: var(--success) !important;
        }

        .status-error {
            color: var(--danger) !important;
        }

        .status-warning {
            color: var(--warning) !important;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status-badge.ok {
            background: var(--success);
            color: white;
        }

        .status-badge.error {
            background: var(--danger);
            color: white;
        }

        .status-badge.warning {
            background: var(--warning);
            color: white;
        }

        .adc-channels {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .adc-channel {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--secondary);
        }

        .channel-name {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .channel-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-left: 4px solid var(--warning);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-left: 4px solid var(--danger);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .last-update {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="topnav">
        <h1><i class="fas fa-bug"></i> <span data-i18n="mainTitle">AquaSensys</span> - <span data-i18n="systemDebug">System Debug</span></h1>
        <div class="nav-right">
            <a href="/"><i class="fas fa-tachometer-alt"></i> <span data-i18n="dashboard">Dashboard</span></a>
            <a href="/diagnostics.html"><i class="fas fa-chart-line"></i> <span data-i18n="diagnostics">Diagnostics</span></a>
            <a href="/settings.html"><i class="fas fa-cog"></i> <span data-i18n="settings">Settings</span></a>
            <div class="language-selector">
                <label for="languageSelector" data-i18n="language">Language</label>
                <select id="languageSelector" onchange="changeLanguage(this.value)">
                    <option value="en" data-i18n="english">English</option>
                    <option value="pt" data-i18n="portuguese">Portuguese</option>
                </select>
            </div>
            <div class="wifi-status" id="wifiStatus">
                <i class="fas fa-wifi"></i> <span id="ipAddress" data-i18n="connecting">Connecting...</span>
            </div>
        </div>
    </div>

    <div class="content">
        <h2 style="color: var(--primary); margin-bottom: 20px;">
            <i class="fas fa-bug"></i> <span data-i18n="systemDebugTitle">System Debug & Hardware Diagnostics</span>
        </h2>

        <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <strong data-i18n="debugWarning">Debug Mode:</strong> <span data-i18n="debugWarningText">This page shows raw hardware values and system internals for troubleshooting. All values update in real-time.</span>
        </div>

        <div class="debug-grid">
            <!-- SD Card Status -->
            <div class="debug-card">
                <h3><i class="fas fa-sd-card"></i> <span data-i18n="sdCardStatus">SD Card Status</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="cardDetected">Card Detected:</span>
                    <span class="debug-value" id="sd_detected">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="cardType">Card Type:</span>
                    <span class="debug-value" id="sd_type">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="cardSize">Card Size:</span>
                    <span class="debug-value" id="sd_size">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="filesCount">Files Count:</span>
                    <span class="debug-value" id="sd_files">--</span>
                </div>
            </div>

            <!-- MCP3208 Status -->
            <div class="debug-card">
                <h3><i class="fas fa-microchip"></i> <span data-i18n="mcpStatus">MCP3208 ADC Status</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="mcpInitialized">Initialized:</span>
                    <span class="debug-value" id="mcp_init">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="mcpVref">Reference Voltage:</span>
                    <span class="debug-value" id="mcp_vref">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="mcpReadErrors">Read Errors:</span>
                    <span class="debug-value" id="mcp_errors">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="spiStatus">SPI Status:</span>
                    <span class="debug-value" id="spi_status">--</span>
                </div>
            </div>

            <!-- Raw ADC Values -->
            <div class="debug-card" style="grid-column: span 2;">
                <h3><i class="fas fa-chart-bar"></i> <span data-i18n="rawAdcValues">Raw ADC Values (0-4095)</span></h3>
                <div class="adc-channels">
                    <div class="adc-channel">
                        <div class="channel-name">CH0 - <span data-i18n="ambientTemp">Ambient Temp</span></div>
                        <div class="channel-value" id="adc_ch0">0000</div>
                    </div>
                    <div class="adc-channel">
                        <div class="channel-name">CH1 - <span data-i18n="pressureOut">Pressure Out</span></div>
                        <div class="channel-value" id="adc_ch1">0000</div>
                    </div>
                    <div class="adc-channel">
                        <div class="channel-name">CH2 - <span data-i18n="pressureIn">Pressure In</span></div>
                        <div class="channel-value" id="adc_ch2">0000</div>
                    </div>
                    <div class="adc-channel">
                        <div class="channel-name">CH3 - <span data-i18n="waterTemp">Water Temp</span></div>
                        <div class="channel-value" id="adc_ch3">0000</div>
                    </div>
                    <div class="adc-channel">
                        <div class="channel-name">CH4 - <span data-i18n="currentL1">Current L1</span></div>
                        <div class="channel-value" id="adc_ch4">0000</div>
                    </div>
                    <div class="adc-channel">
                        <div class="channel-name">CH5 - <span data-i18n="currentL2">Current L2</span></div>
                        <div class="channel-value" id="adc_ch5">0000</div>
                    </div>
                    <div class="adc-channel">
                        <div class="channel-name">CH6 - <span data-i18n="currentL3">Current L3</span></div>
                        <div class="channel-value" id="adc_ch6">0000</div>
                    </div>
                    <div class="adc-channel">
                        <div class="channel-name">CH7 - <span data-i18n="unused">Unused</span></div>
                        <div class="channel-value" id="adc_ch7">0000</div>
                    </div>
                </div>
            </div>

            <!-- Voltage Readings -->
            <div class="debug-card">
                <h3><i class="fas fa-bolt"></i> <span data-i18n="voltageReadings">Voltage Readings</span></h3>
                <div class="debug-item">
                    <span class="debug-label">CH0 <span data-i18n="voltage">Voltage</span>:</span>
                    <span class="debug-value" id="volt_ch0">0.000 V</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">CH1 <span data-i18n="voltage">Voltage</span>:</span>
                    <span class="debug-value" id="volt_ch1">0.000 V</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">CH2 <span data-i18n="voltage">Voltage</span>:</span>
                    <span class="debug-value" id="volt_ch2">0.000 V</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">CH3 <span data-i18n="voltage">Voltage</span>:</span>
                    <span class="debug-value" id="volt_ch3">0.000 V</span>
                </div>
            </div>

            <!-- Processed Sensor Values -->
            <div class="debug-card">
                <h3><i class="fas fa-tachometer-alt"></i> <span data-i18n="processedValues">Processed Sensor Values</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="inletPressure">Inlet Pressure:</span>
                    <span class="debug-value" id="proc_press_in">0.00 bar</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="outletPressure">Outlet Pressure:</span>
                    <span class="debug-value" id="proc_press_out">0.00 bar</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="ambientTemp">Ambient Temp:</span>
                    <span class="debug-value" id="proc_temp_amb">0.00 째C</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="waterTemp">Water Temp:</span>
                    <span class="debug-value" id="proc_temp_water">0.00 째C</span>
                </div>
            </div>

            <!-- Calibration Offsets -->
            <div class="debug-card">
                <h3><i class="fas fa-sliders-h"></i> <span data-i18n="calibrationOffsets">Calibration Offsets</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="pressureInOffset">Pressure In Offset:</span>
                    <span class="debug-value" id="cal_press_in">0.000 bar</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="pressureOutOffset">Pressure Out Offset:</span>
                    <span class="debug-value" id="cal_press_out">0.000 bar</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="currentL1Offset">Current L1 Offset:</span>
                    <span class="debug-value" id="cal_curr_l1">0.00 mA</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="currentL2Offset">Current L2 Offset:</span>
                    <span class="debug-value" id="cal_curr_l2">0.00 mA</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="currentL3Offset">Current L3 Offset:</span>
                    <span class="debug-value" id="cal_curr_l3">0.00 mA</span>
                </div>
            </div>

            <!-- System Information -->
            <div class="debug-card">
                <h3><i class="fas fa-info-circle"></i> <span data-i18n="systemInformation">System Information</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="freeHeap">Free Heap:</span>
                    <span class="debug-value" id="sys_heap">0 KB</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="uptime">Uptime:</span>
                    <span class="debug-value" id="sys_uptime">0s</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="resetReason">Reset Reason:</span>
                    <span class="debug-value" id="sys_reset">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="cpuFreq">CPU Frequency:</span>
                    <span class="debug-value" id="sys_cpu_freq">-- MHz</span>
                </div>
            </div>

            <!-- WiFi Status -->
            <div class="debug-card">
                <h3><i class="fas fa-wifi"></i> <span data-i18n="wifiStatus">WiFi Status</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="wifiConnected">Connected:</span>
                    <span class="debug-value" id="wifi_connected">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="wifiSsid">SSID:</span>
                    <span class="debug-value" id="wifi_ssid">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="wifiRssi">Signal (RSSI):</span>
                    <span class="debug-value" id="wifi_rssi">-- dBm</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="ipAddress">IP Address:</span>
                    <span class="debug-value" id="wifi_ip">--</span>
                </div>
            </div>

            <!-- MQTT Status -->
            <div class="debug-card">
                <h3><i class="fas fa-share-alt"></i> <span data-i18n="mqttStatus">MQTT Status</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="mqttConnected">Connected:</span>
                    <span class="debug-value" id="mqtt_connected">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="mqttServer">Server:</span>
                    <span class="debug-value" id="mqtt_server">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="mqttPort">Port:</span>
                    <span class="debug-value" id="mqtt_port">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="lastMqttMsg">Last Message:</span>
                    <span class="debug-value" id="mqtt_last">-- s ago</span>
                </div>
            </div>

            <!-- Motor & Control State -->
            <div class="debug-card">
                <h3><i class="fas fa-cogs"></i> <span data-i18n="motorControl">Motor & Control State</span></h3>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="motorState">Motor:</span>
                    <span class="debug-value" id="ctrl_motor">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="mainSwitch">Main Switch:</span>
                    <span class="debug-value" id="ctrl_main_switch">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="manualOverride">Manual Override:</span>
                    <span class="debug-value" id="ctrl_override">--</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label" data-i18n="errorState">Error State:</span>
                    <span class="debug-value" id="ctrl_error">--</span>
                </div>
            </div>
        </div>

        <div class="last-update">
            <i class="fas fa-sync-alt"></i> <span data-i18n="lastUpdated">Last updated</span>: <span id="lastUpdate"><span data-i18n="never">Never</span></span>
        </div>
    </div>

    <script src="translations.js"></script>
    <script src="language.js"></script>
    <script>
        let eventSource;
        let isConnected = false;

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/events');

            eventSource.onopen = () => {
                console.log('SSE connection opened');
                isConnected = true;
                updateConnectionStatus(true);
            };

            eventSource.onerror = (e) => {
                console.log('SSE error:', e);
                isConnected = false;
                updateConnectionStatus(false);

                eventSource.close();
                setTimeout(connectSSE, 3000);
            };

            // Listen for debug data updates
            eventSource.addEventListener('debug', (e) => {
                try {
                    const data = JSON.parse(e.data);
                    updateDebugData(data);
                } catch (err) {
                    console.error('Error parsing debug data:', err);
                }
            });
        }

        function updateDebugData(data) {
            // SD Card Status
            if (data.sd_detected !== undefined) {
                document.getElementById('sd_detected').textContent = data.sd_detected ? 'YES' : 'NO';
                document.getElementById('sd_detected').className = 'debug-value ' + (data.sd_detected ? 'status-ok' : 'status-error');
            }
            if (data.sd_type !== undefined) document.getElementById('sd_type').textContent = data.sd_type;
            if (data.sd_size !== undefined) document.getElementById('sd_size').textContent = formatBytes(data.sd_size);
            if (data.sd_files !== undefined) document.getElementById('sd_files').textContent = data.sd_files;

            // MCP3208 Status
            if (data.mcp_init !== undefined) {
                document.getElementById('mcp_init').textContent = data.mcp_init ? 'YES' : 'NO';
                document.getElementById('mcp_init').className = 'debug-value ' + (data.mcp_init ? 'status-ok' : 'status-error');
            }
            if (data.mcp_vref !== undefined) document.getElementById('mcp_vref').textContent = data.mcp_vref.toFixed(2) + ' V';
            if (data.mcp_errors !== undefined) {
                document.getElementById('mcp_errors').textContent = data.mcp_errors;
                document.getElementById('mcp_errors').className = 'debug-value ' + (data.mcp_errors > 0 ? 'status-error' : 'status-ok');
            }
            if (data.spi_status !== undefined) document.getElementById('spi_status').textContent = data.spi_status;

            // Raw ADC Values
            for (let i = 0; i < 8; i++) {
                if (data['adc_ch' + i] !== undefined) {
                    document.getElementById('adc_ch' + i).textContent = String(data['adc_ch' + i]).padStart(4, '0');
                }
            }

            // Voltage Readings
            for (let i = 0; i < 4; i++) {
                if (data['volt_ch' + i] !== undefined) {
                    document.getElementById('volt_ch' + i).textContent = data['volt_ch' + i].toFixed(3) + ' V';
                }
            }

            // Processed Values
            if (data.pressure_in !== undefined) document.getElementById('proc_press_in').textContent = data.pressure_in.toFixed(2) + ' bar';
            if (data.pressure_out !== undefined) document.getElementById('proc_press_out').textContent = data.pressure_out.toFixed(2) + ' bar';
            if (data.temp_ambient !== undefined) document.getElementById('proc_temp_amb').textContent = data.temp_ambient.toFixed(2) + ' 째C';
            if (data.temp_water !== undefined) document.getElementById('proc_temp_water').textContent = data.temp_water.toFixed(2) + ' 째C';

            // Calibration Offsets
            if (data.cal_press_in !== undefined) document.getElementById('cal_press_in').textContent = data.cal_press_in.toFixed(3) + ' bar';
            if (data.cal_press_out !== undefined) document.getElementById('cal_press_out').textContent = data.cal_press_out.toFixed(3) + ' bar';
            if (data.cal_curr_l1 !== undefined) document.getElementById('cal_curr_l1').textContent = data.cal_curr_l1.toFixed(2) + ' mA';
            if (data.cal_curr_l2 !== undefined) document.getElementById('cal_curr_l2').textContent = data.cal_curr_l2.toFixed(2) + ' mA';
            if (data.cal_curr_l3 !== undefined) document.getElementById('cal_curr_l3').textContent = data.cal_curr_l3.toFixed(2) + ' mA';

            // System Information
            if (data.free_heap !== undefined) document.getElementById('sys_heap').textContent = (data.free_heap / 1024).toFixed(1) + ' KB';
            if (data.uptime !== undefined) document.getElementById('sys_uptime').textContent = formatUptime(data.uptime);
            if (data.reset_reason !== undefined) document.getElementById('sys_reset').textContent = data.reset_reason;
            if (data.cpu_freq !== undefined) document.getElementById('sys_cpu_freq').textContent = data.cpu_freq + ' MHz';

            // WiFi Status
            if (data.wifi_connected !== undefined) {
                document.getElementById('wifi_connected').textContent = data.wifi_connected ? 'YES' : 'NO';
                document.getElementById('wifi_connected').className = 'debug-value ' + (data.wifi_connected ? 'status-ok' : 'status-error');
            }
            if (data.wifi_ssid !== undefined) document.getElementById('wifi_ssid').textContent = data.wifi_ssid;
            if (data.wifi_rssi !== undefined) document.getElementById('wifi_rssi').textContent = data.wifi_rssi + ' dBm';
            if (data.wifi_ip !== undefined) document.getElementById('wifi_ip').textContent = data.wifi_ip;

            // MQTT Status
            if (data.mqtt_connected !== undefined) {
                document.getElementById('mqtt_connected').textContent = data.mqtt_connected ? 'YES' : 'NO';
                document.getElementById('mqtt_connected').className = 'debug-value ' + (data.mqtt_connected ? 'status-ok' : 'status-error');
            }
            if (data.mqtt_server !== undefined) document.getElementById('mqtt_server').textContent = data.mqtt_server;
            if (data.mqtt_port !== undefined) document.getElementById('mqtt_port').textContent = data.mqtt_port;
            if (data.mqtt_last !== undefined) document.getElementById('mqtt_last').textContent = data.mqtt_last + ' s ago';

            // Motor & Control
            if (data.motor !== undefined) {
                document.getElementById('ctrl_motor').textContent = data.motor ? 'ON' : 'OFF';
                document.getElementById('ctrl_motor').className = 'debug-value ' + (data.motor ? 'status-ok' : 'status-error');
            }
            if (data.main_switch !== undefined) {
                document.getElementById('ctrl_main_switch').textContent = data.main_switch ? 'ON' : 'OFF';
                document.getElementById('ctrl_main_switch').className = 'debug-value ' + (data.main_switch ? 'status-ok' : 'status-error');
            }
            if (data.manual_override !== undefined) {
                document.getElementById('ctrl_override').textContent = data.manual_override ? 'YES' : 'NO';
                document.getElementById('ctrl_override').className = 'debug-value ' + (data.manual_override ? 'status-warning' : 'status-ok');
            }
            if (data.error !== undefined) {
                document.getElementById('ctrl_error').textContent = data.error ? 'ERROR' : 'OK';
                document.getElementById('ctrl_error').className = 'debug-value ' + (data.error ? 'status-error' : 'status-ok');
            }

            // Update last update time
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            let result = '';
            if (days > 0) result += days + 'd ';
            if (hours > 0) result += hours + 'h ';
            if (minutes > 0) result += minutes + 'm ';
            result += secs + 's';

            return result;
        }

        function updateConnectionStatus(connected) {
            const wifiIcon = document.querySelector('#wifiStatus i');
            const statusText = connected ? window.location.hostname : 'Disconnected';

            wifiIcon.className = connected ? 'fas fa-wifi' : 'fas fa-wifi-slash';
            wifiIcon.style.color = connected ? '#4bb543' : '#ec0b43';
            document.getElementById('ipAddress').textContent = statusText;
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initializeLanguage === 'function') {
                initializeLanguage();
            }

            connectSSE();
        });
    </script>
</body>
</html>
